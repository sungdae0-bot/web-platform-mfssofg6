<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BS Investment Committee Platform V8.5</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js" defer></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Pretendard', 'Noto Sans KR', sans-serif; }
        .container { max-width: 1100px; margin-top: 30px; margin-bottom: 50px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .radar-chart-container { position: relative; height: 400px; width: 100%; }
        .hidden { display: none !important; }
        
        .table th, .table td { 
            white-space: nowrap; 
            vertical-align: middle;
            text-align: center;
        }
        .table th { 
            background-color: #f8f9fa; 
            font-weight: 700; 
            color: #495057; 
            border-bottom: 2px solid #dee2e6; 
            padding: 15px 10px;
        }
        .table td { 
            padding: 12px 10px; 
            border-bottom: 1px solid #e9ecef; 
        }

        .col-type  { width: 12%; }
        .col-name  { width: 38%; }
        .col-date  { width: 14%; }
        .col-status { width: 36%; }

        .table tfoot td {
            background-color: #f1f3f5;
            font-weight: 700;
            color: #343a40;
            border-top: 2px solid #dee2e6;
            padding: 12px 10px;
        }

        .filter-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        .filter-panel .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .filter-group label {
            font-size: 0.78rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 2px;
        }
        .filter-group input[type="date"],
        .filter-group input[type="number"] {
            font-size: 0.85rem;
            padding: 4px 8px;
            height: 34px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            width: 130px;
        }
        .filter-check-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .filter-check-group .form-check {
            margin: 0;
        }
        .filter-range-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-range-wrap span {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .btn-filter-reset {
            font-size: 0.82rem;
            padding: 5px 14px;
            height: 34px;
            align-self: flex-end;
        }

        .invest-proceed   { color: #0d6efd; font-weight: 700; }
        .invest-noproceed { color: #dc3545; font-weight: 700; }

        .invest-status-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .feedback-box { background: #fff; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #0d6efd; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .feedback-box.cons { border-left-color: #dc3545; }
        .feedback-box.syn  { border-left-color: #198754; }
        .score-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f5; }
        .score-list-item:last-child { border-bottom: none; }
        .score-detail { font-size: 0.8rem; color: #6c757d; margin-left: 5px; }
        .total-score { font-size: 1.8rem; font-weight: bold; color: #0d6efd; text-align: center; margin-bottom: 5px; }
        .chart-controls label { font-size: 0.85rem; margin-right: 15px; cursor: pointer; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,1); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s ease; }
        #global-error-msg { color: red; margin-top: 20px; font-weight: bold; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div id="global-error-msg"></div>
</div>

<nav id="navbar" class="navbar navbar-expand-lg navbar-light bg-white shadow-sm hidden">
    <div class="container-fluid">
        <span class="navbar-brand fw-bold ms-3">ğŸ›ï¸ BS Investment Committee</span>
        <div class="d-flex align-items-center me-3">
            <span id="user-display-name" class="me-3 fw-bold text-primary"></span>
            <button id="btn-settings" class="btn btn-outline-secondary btn-sm me-2" title="ì´ë¦„ ë³€ê²½"><i class="fas fa-cog"></i></button>
            <button id="btn-home" class="btn btn-outline-secondary btn-sm me-2"><i class="fas fa-home"></i> í™ˆ</button>
            <button id="btn-logout" class="btn btn-outline-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</nav>

<div class="container">

    <div id="login-section" class="hidden">
        <div class="row justify-content-center align-items-center" style="height: 80vh;">
            <div class="col-md-5">
                <div class="card p-5">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold">Login</h3>
                        <p class="text-muted small">íˆ¬ìì‹¬ì˜ í”Œë«í¼ (Firebase Auth)</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì´ë©”ì¼ (ID)</label>
                        <input type="text" id="login-email" class="form-control" placeholder="ì´ë©”ì¼ ì…ë ¥ (ê´€ë¦¬ì: admin)">
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold">ë¹„ë°€ë²ˆí˜¸ (Password)</label>
                        <input type="password" id="login-pw" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    </div>
                    <button id="btn-login-action" class="btn btn-primary w-100 py-2 fw-bold">ë¡œê·¸ì¸</button>
                    <p id="login-error" class="text-danger text-center mt-3 small"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="nameSettingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤!</h5>
                </div>
                <div class="modal-body">
                    <p class="text-muted">ì‚¬ìš©í•  ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>(ìµœì´ˆ 1íšŒë§Œ ì…ë ¥)</p>
                    <input type="text" id="input-display-name" class="form-control" placeholder="ì˜ˆ: í™ê¸¸ë™">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" id="btn-save-name">ì‹œì‘í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <h4 class="mb-3">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h4>
        
        <div class="card p-4 mb-4">
            <h5>â• ì‹ ê·œ ì•ˆê±´ ë“±ë¡</h5>
            <div class="row g-2">
                <div class="col-md-3">
                    <select id="new-type" class="form-select">
                        <option value="startup">Startup</option>
                        <option value="fund">Fund</option>
                    </select>
                </div>
                <div class="col-md-7"><input type="text" id="new-name" class="form-control" placeholder="ê¸°ì—…ëª… ë˜ëŠ” í€ë“œëª…"></div>
                <div class="col-md-2"><button id="btn-create-session" class="btn btn-success w-100">ë“±ë¡</button></div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-manage">ğŸ“‹ í‰ê°€ ê´€ë¦¬</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-history">ğŸ—„ï¸ ê³¼ê±° ì‹¬ì‚¬ ì´ë ¥</button></li>
        </ul>
        
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-manage">
                <div class="card p-3">
                    <div class="d-flex justify-content-end mb-2">
                        <button id="btn-toggle-edit-mode" class="btn btn-sm btn-outline-secondary"><i class="fas fa-tools"></i> ëª©ë¡ í¸ì§‘ (ìˆœì„œ/ì‚­ì œ)</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:6%;">#</th>
                                    <th class="col-type">êµ¬ë¶„</th>
                                    <th class="col-name">ì•ˆê±´ëª…</th>
                                    <th class="col-date">ë“±ë¡ì¼</th>
                                    <th class="col-status" id="th-status-title">ê´€ë¦¬ ë° ê²°ê³¼</th>
                                </tr>
                            </thead>
                            <tbody id="admin-session-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-history">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">ì „ì²´ íˆ¬ì ê±´ ë¦¬ìŠ¤íŠ¸</h5>
                        <div class="d-flex gap-2">
                            <button id="btn-toggle-filter" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-filter"></i> í•„í„°
                            </button>
                            <button id="btn-excel-download" class="btn btn-sm btn-outline-success">
                                ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>

                    <div id="filter-panel" class="filter-panel hidden">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Type</label>
                                <div class="filter-check-group">
                                    <div class="form-check">
                                        <input class="form-check-input filter-type" type="checkbox" value="startup" id="flt-startup" checked>
                                        <label class="form-check-label small" for="flt-startup">Startup</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input filter-type" type="checkbox" value="fund" id="flt-fund" checked>
                                        <label class="form-check-label small" for="flt-fund">Fund</label>
                                    </div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>Date (ë“±ë¡ì¼ ë²”ìœ„)</label>
                                <div class="filter-range-wrap">
                                    <input type="date" id="flt-date-from">
                                    <span>~</span>
                                    <input type="date" id="flt-date-to">
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>ì°¸ì—¬ ì¸ì› (ëª…)</label>
                                <div class="filter-range-wrap">
                                    <input type="number" id="flt-part-min" placeholder="ìµœì†Œ" min="0">
                                    <span>~</span>
                                    <input type="number" id="flt-part-max" placeholder="ìµœëŒ€" min="0">
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>ì¢…í•©ì ìˆ˜ (0 ~ 5)</label>
                                <div class="filter-range-wrap">
                                    <input type="number" id="flt-score-min" placeholder="ìµœì†Œ" min="0" max="5" step="0.1">
                                    <span>~</span>
                                    <input type="number" id="flt-score-max" placeholder="ìµœëŒ€" min="0" max="5" step="0.1">
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>ìƒíƒœ</label>
                                <div class="filter-check-group">
                                    <div class="form-check">
                                        <input class="form-check-input filter-status" type="checkbox" value="ongoing" id="flt-ongoing" checked>
                                        <label class="form-check-label small" for="flt-ongoing">ì§„í–‰ì¤‘</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input filter-status" type="checkbox" value="done" id="flt-done" checked>
                                        <label class="form-check-label small" for="flt-done">ì™„ë£Œ</label>
                                    </div>
                                </div>
                            </div>
                            <button id="btn-filter-reset" class="btn btn-sm btn-outline-secondary btn-filter-reset">
                                <i class="fas fa-undo"></i> ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="history-table">
                            <thead>
                                <tr>
                                    <th style="width:5%;">#</th>
                                    <th style="width:9%;">Type</th>
                                    <th>Name</th>
                                    <th style="width:11%;">Date</th>
                                    <th style="width:8%;">ì°¸ì—¬</th>
                                    <th style="width:10%;">ì¢…í•©ì ìˆ˜</th>
                                    <th style="width:10%;">íˆ¬ìì§„í–‰</th>
                                    <th style="width:9%;">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody id="admin-history-list"></tbody>
                            <tfoot id="admin-history-footer"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-monitoring" class="hidden">
        <button id="btn-monitor-back" class="btn btn-secondary mb-3"><i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ</button>
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 id="monitor-title" class="fw-bold"></h4>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="anon-toggle">
                    <label class="form-check-label" for="anon-toggle">ìµëª…ìœ¼ë¡œ ë³´ê¸°</label>
                </div>
            </div>

            <div class="invest-status-bar">
                <span class="fw-bold me-2">ğŸ“Œ íˆ¬ìì§„í–‰ ì—¬ë¶€:</span>
                <button id="btn-invest-proceed"   class="btn btn-sm btn-outline-primary">âœ… ì§„í–‰</button>
                <button id="btn-invest-noproceed" class="btn btn-sm btn-outline-danger">âŒ ë¯¸ì§„í–‰</button>
                <button id="btn-invest-clear"     class="btn btn-sm btn-outline-secondary">â€” ë¯¸ì„¤ì •</button>
                <span id="invest-status-label" class="ms-3 fw-bold fs-6"></span>
            </div>

            <div class="row mb-5">
                <div class="col-md-8">
                    <div class="radar-chart-container"><canvas id="adminChart"></canvas></div>
                    <div class="mt-3 p-3 bg-light rounded chart-controls" id="chart-users-toggle"></div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light h-100">
                        <div class="card-body">
                            <h5 class="card-title text-center mb-2">ì¢…í•© í‰ê°€ ì ìˆ˜</h5>
                            <div class="total-score" id="total-score-display">0.0</div>
                            <p class="text-center text-muted small mb-4">All Score Average</p>
                            <hr>
                            <h6 class="text-muted mb-3">í•­ëª©ë³„ ìƒì„¸ ì ìˆ˜</h6>
                            <div id="score-breakdown-list" class="small"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4"><h6 class="text-primary fw-bold">ğŸ‘ íˆ¬ìí•´ì•¼ í•˜ëŠ” ì´ìœ </h6><div id="fb-pros-list"></div></div>
                <div class="col-md-4"><h6 class="text-danger fw-bold">âš ï¸ ì£¼ìš” ìš°ë ¤ì‚¬í•­</h6><div id="fb-cons-list"></div></div>
                <div class="col-md-4"><h6 class="text-success fw-bold">ğŸ¤ ê¸°ëŒ€ë˜ëŠ” ì‹œë„ˆì§€ íš¨ê³¼</h6><div id="fb-syn-list"></div></div>
            </div>
        </div>
    </div>

    <div id="ic-dashboard" class="hidden">
        <h4 class="mb-3">ì‹¬ì‚¬ ëŒ€ìƒ ëª©ë¡</h4>
        <div class="card p-3"><div class="list-group" id="ic-session-list"></div></div>
    </div>

    <div id="ic-evaluation" class="hidden">
        <button id="btn-eval-back" class="btn btn-secondary mb-3"><i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ</button>
        <div class="card p-4">
            <h4 id="eval-title" class="fw-bold mb-4"></h4>
            <h5 class="mb-3 border-bottom pb-2">ğŸ“Š í•­ëª©ë³„ í‰ê°€</h5>
            <div id="criteria-inputs" class="mb-5"></div>
            <h5 class="mb-3 border-bottom pb-2">ğŸ“ íˆ¬ì ê´€ë ¨ ì˜ê²¬</h5>
            <div class="mb-3"><label class="fw-bold">1. íˆ¬ì í•´ì•¼í•˜ëŠ” ì´ìœ </label><textarea id="comment-pros" class="form-control" rows="2"></textarea></div>
            <div class="mb-3"><label class="fw-bold">2. ì£¼ìš” ìš°ë ¤ì‚¬í•­</label><textarea id="comment-cons" class="form-control" rows="2"></textarea></div>
            <div class="mb-3"><label class="fw-bold">3. ê¸°ëŒ€ë˜ëŠ” ì‹œë„ˆì§€ íš¨ê³¼</label><textarea id="comment-synergy" class="form-control" rows="2"></textarea></div>
            <button id="btn-submit-eval" class="btn btn-primary w-100 py-2 fs-5">í‰ê°€ ì œì¶œ</button>
        </div>
    </div>
</div>

<script type="module">
    window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('loading-overlay').classList.remove('hidden');
        document.getElementById('global-error-msg').innerText = "ì˜¤ë¥˜ ë°œìƒ: " + message;
        console.error(error);
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCjawYoNR9zABRyr9q9hW_-cd2PntgA_Zs",
        authDomain: "bs-investement-committee.firebaseapp.com",
        databaseURL: "https://bs-investement-committee-default-rtdb.firebaseio.com",
        projectId: "bs-investement-committee",
        storageBucket: "bs-investement-committee.firebasestorage.app",
        messagingSenderId: "1019720410388",
        appId: "1:1019720410388:web:ac46ca0740ec2b597ace01"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const db  = getDatabase(app);
        const auth = getAuth(app);

        let currentUser           = null;
        let currentUserName       = "";
        let currentRole           = "";
        let currentSessionId      = "";
        let sessionsData          = {};
        let myRadarChart          = null;
        let selectedUsersForChart = [];
        let nameModal             = null;
        let isEditMode            = false;

        let filterState = {
            types:    ['startup', 'fund'],
            dateFrom: '', dateTo: '',
            partMin:  '', partMax: '',
            scoreMin: '', scoreMax: '',
            statuses: ['ongoing', 'done']
        };

        const criteria = {
            startup: ["íŒ€ ì—­ëŸ‰", "ì‹œì¥ì„±", "ê¸°ìˆ  í•´ì", "ì‚¬ì—…ì„±/BM", "íšŒìˆ˜ ê°€ëŠ¥ì„±", "ì „ëµì  ì •í•©ì„±"],
            fund:    ["GP ì—­ëŸ‰", "ìš´ìš© ì „ëµ", "ìˆ˜ìµ/íšŒìˆ˜", "ë„¤íŠ¸ì›Œí¬", "ì •ë³´/ì¸ì‚¬ì´íŠ¸", "ì „ëµì  ì •í•©ì„±"]
        };

        function initApp() {
            bindClick('btn-login-action',     performLogin);
            bindClick('btn-logout',           performLogout);
            bindClick('btn-settings',         openNameSettings);
            bindClick('btn-home',             goHome);
            bindClick('btn-save-name',        saveUserName);
            bindClick('btn-create-session',   createSession);
            bindClick('btn-monitor-back',     goHome);
            bindClick('btn-eval-back',        goHome);
            bindClick('btn-submit-eval',      submitEvaluation);
            bindClick('btn-excel-download',   downloadExcel);
            bindClick('btn-toggle-edit-mode', toggleEditMode);

            bindClick('btn-toggle-filter', () =>
                document.getElementById('filter-panel').classList.toggle('hidden')
            );
            bindClick('btn-filter-reset', resetFilter);

            document.querySelectorAll('.filter-type, .filter-status').forEach(el =>
                el.addEventListener('change', onFilterChange)
            );
            ['flt-date-from','flt-date-to','flt-part-min','flt-part-max',
             'flt-score-min','flt-score-max'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', onFilterChange);
            });

            bindClick('btn-invest-proceed',   () => setInvestStatus('proceed'));
            bindClick('btn-invest-noproceed', () => setInvestStatus('noproceed'));
            bindClick('btn-invest-clear',     () => setInvestStatus(null));

            const pwInput = document.getElementById('login-pw');
            if(pwInput) pwInput.addEventListener('keypress', e => { if(e.key === 'Enter') performLogin(); });

            const anonToggle = document.getElementById('anon-toggle');
            if(anonToggle) anonToggle.addEventListener('change', refreshMonitorView);

            onAuthStateChanged(auth, (user) => {
                document.getElementById('loading-overlay').classList.add('hidden');
                if(!nameModal && window.bootstrap)
                    nameModal = new bootstrap.Modal(document.getElementById('nameSettingModal'));

                if (user) {
                    currentUser = user;
                    if(user.email.startsWith("admin@")) {
                        currentRole     = 'admin';
                        currentUserName = "ê´€ë¦¬ì";
                    } else {
                        currentRole     = 'ic';
                        currentUserName = user.displayName;
                    }
                    updateUserDisplay();
                    document.getElementById('navbar').classList.remove('hidden');
                    document.getElementById('login-section').classList.add('hidden');
                    if(currentRole === 'ic' && !user.displayName) {
                        if(nameModal) nameModal.show();
                    } else {
                        goHome();
                        syncData();
                    }
                } else {
                    document.getElementById('navbar').classList.add('hidden');
                    hideAllSections();
                    document.getElementById('login-section').classList.remove('hidden');
                }
            });
        }

        initApp();

        function bindClick(id, func) {
            const el = document.getElementById(id);
            if(el) el.addEventListener('click', func);
        }

        function calcSessionAvg(s) {
            const evals = s.evaluations || {};
            const count = Object.keys(evals).length;
            if(count === 0) return null;
            let grandSum = 0, itemCount = 0;
            for(let u in evals) evals[u].scores.forEach(v => { grandSum += v; itemCount++; });
            return itemCount > 0 ? parseFloat((grandSum / itemCount).toFixed(1)) : null;
        }

        function onFilterChange() {
            filterState.types    = [...document.querySelectorAll('.filter-type:checked')].map(e => e.value);
            filterState.statuses = [...document.querySelectorAll('.filter-status:checked')].map(e => e.value);
            filterState.dateFrom = document.getElementById('flt-date-from').value;
            filterState.dateTo   = document.getElementById('flt-date-to').value;
            filterState.partMin  = document.getElementById('flt-part-min').value;
            filterState.partMax  = document.getElementById('flt-part-max').value;
            filterState.scoreMin = document.getElementById('flt-score-min').value;
            filterState.scoreMax = document.getElementById('flt-score-max').value;
            renderAdminList();
        }

        function resetFilter() {
            document.querySelectorAll('.filter-type, .filter-status').forEach(el => el.checked = true);
            ['flt-date-from','flt-date-to','flt-part-min','flt-part-max',
             'flt-score-min','flt-score-max'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            filterState = {
                types: ['startup','fund'], dateFrom:'', dateTo:'',
                partMin:'', partMax:'', scoreMin:'', scoreMax:'',
                statuses: ['ongoing','done']
            };
            renderAdminList();
        }

        function applyFilter(keys) {
            return keys.filter(key => {
                const s = sessionsData[key];
                if(!s) return false;
                if(!filterState.types.includes(s.type)) return false;
                if(filterState.dateFrom) {
                    const from = new Date(filterState.dateFrom).getTime();
                    if(s.createdAt < from) return false;
                }
                if(filterState.dateTo) {
                    const to = new Date(filterState.dateTo).getTime() + 86399999;
                    if(s.createdAt > to) return false;
                }
                const count = s.evaluations ? Object.keys(s.evaluations).length : 0;
                if(filterState.partMin !== '' && count < parseInt(filterState.partMin)) return false;
                if(filterState.partMax !== '' && count > parseInt(filterState.partMax)) return false;
                const avg    = calcSessionAvg(s);
                const avgVal = avg !== null ? avg : 0;
                if(filterState.scoreMin !== '' && avgVal < parseFloat(filterState.scoreMin)) return false;
                if(filterState.scoreMax !== '' && avgVal > parseFloat(filterState.scoreMax)) return false;
                const statusVal = s.isVisible ? 'ongoing' : 'done';
                if(!filterState.statuses.includes(statusVal)) return false;
                return true;
            });
        }

        function setInvestStatus(status) {
            if(!currentSessionId) return;
            update(ref(db, `sessions/${currentSessionId}`), { investStatus: status })
                .then(() => renderInvestStatusLabel(status))
                .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err.message));
        }

        function renderInvestStatusLabel(status) {
            const label = document.getElementById('invest-status-label');
            if(status === 'proceed')
                label.innerHTML = '<span class="invest-proceed">â— ì§„í–‰</span>';
            else if(status === 'noproceed')
                label.innerHTML = '<span class="invest-noproceed">â— ë¯¸ì§„í–‰</span>';
            else
                label.innerHTML = '<span class="text-muted">ë¯¸ì„¤ì •</span>';
        }

        function downloadExcel() {
            if(!sessionsData || Object.keys(sessionsData).length === 0)
                return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const exportData   = [];
            const filteredKeys = applyFilter(getSortedKeys());

            filteredKeys.forEach((key, idx) => {
                const s     = sessionsData[key];
                const date  = new Date(s.createdAt).toLocaleDateString();
                const count = s.evaluations ? Object.keys(s.evaluations).length : 0;
                const avg   = calcSessionAvg(s);
                const investLabel = s.investStatus === 'proceed'   ? 'ì§„í–‰'
                                  : s.investStatus === 'noproceed' ? 'ë¯¸ì§„í–‰' : '-';
                exportData.push({
                    "#": idx + 1,
                    "êµ¬ë¶„":      s.type.toUpperCase(),
                    "ì•ˆê±´ëª…":    s.name,
                    "ë“±ë¡ì¼":    date,
                    "ì°¸ì—¬ ì¸ì›": count + "ëª…",
                    "ì¢…í•© ì ìˆ˜": avg !== null ? avg : "0.0",
                    "íˆ¬ìì§„í–‰":  investLabel,
                    "ìƒíƒœ":      s.isVisible ? "ì§„í–‰ì¤‘" : "ì™„ë£Œ"
                });
            });

            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook  = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ì‹¬ì‚¬ ì´ë ¥");
            const today = new Date().toISOString().slice(0,10);
            XLSX.writeFile(workbook, `íˆ¬ìì‹¬ì‚¬ì´ë ¥_${today}.xlsx`);
        }

        async function performLogin() {
            let email = document.getElementById('login-email').value.trim();
            const pw  = document.getElementById('login-pw').value;
            const errorMsg = document.getElementById('login-error');
            errorMsg.innerText = "";
            if(!email || !pw) return alert("ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            if(email === 'admin') email = 'admin@bs-invest.com';
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, pw);
            } catch (error) {
                document.getElementById('loading-overlay').classList.add('hidden');
                let msg = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ";
                if(error.code === 'auth/user-not-found')      msg += "ê³„ì • ì—†ìŒ";
                else if(error.code === 'auth/wrong-password') msg += "ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
                else msg += error.message;
                errorMsg.innerText = msg;
            }
        }

        function performLogout() { signOut(auth).then(() => location.reload()); }

        function saveUserName() {
            const inputName = document.getElementById('input-display-name').value.trim();
            if(!inputName) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            updateProfile(auth.currentUser, { displayName: inputName }).then(() => {
                currentUserName = inputName;
                updateUserDisplay();
                if(nameModal) nameModal.hide();
                goHome();
                syncData();
            });
        }

        function openNameSettings() {
            if(currentRole === 'admin') return alert("ê´€ë¦¬ìëŠ” ì´ë¦„ ë³€ê²½ ë¶ˆê°€");
            document.getElementById('input-display-name').value = currentUserName || "";
            if(nameModal) nameModal.show();
        }

        function updateUserDisplay() {
            const display = document.getElementById('user-display-name');
            if(currentRole === 'admin') {
                display.innerText = `ğŸ‘¤ ê´€ë¦¬ì (Admin)`;
                display.classList.remove('text-primary'); display.classList.add('text-danger');
            } else {
                display.innerText = `ğŸ‘¤ ${currentUserName} ìœ„ì›`;
                display.classList.remove('text-danger'); display.classList.add('text-primary');
            }
        }

        function goHome() {
            hideAllSections();
            if(currentRole === 'admin') document.getElementById('admin-dashboard').classList.remove('hidden');
            else                        document.getElementById('ic-dashboard').classList.remove('hidden');
        }

        function hideAllSections() {
            ['login-section','admin-dashboard','admin-monitoring','ic-dashboard','ic-evaluation']
                .forEach(sid => document.getElementById(sid).classList.add('hidden'));
        }

        function syncData() {
            onValue(ref(db, 'sessions'), (snapshot) => {
                sessionsData = snapshot.val() || {};
                if(currentRole === 'admin') {
                    renderAdminList();
                    if(!document.getElementById('admin-monitoring').classList.contains('hidden') && currentSessionId)
                        loadMonitorData(currentSessionId);
                } else {
                    renderIcList();
                }
            });
        }

        function getSortedKeys() {
            return Object.keys(sessionsData).sort((a, b) => {
                const oA = sessionsData[a].order !== undefined ? sessionsData[a].order : 0;
                const oB = sessionsData[b].order !== undefined ? sessionsData[b].order : 0;
                if(oA !== oB) return oA - oB;
                return sessionsData[b].createdAt - sessionsData[a].createdAt;
            });
        }

        function renderAdminList() {
            const listBody    = document.getElementById('admin-session-list');
            const historyBody = document.getElementById('admin-history-list');
            const historyFoot = document.getElementById('admin-history-footer');
            listBody.innerHTML = ""; historyBody.innerHTML = ""; historyFoot.innerHTML = "";

            const sortedKeys   = getSortedKeys();
            const filteredKeys = applyFilter(sortedKeys);

            // í‰ê°€ ê´€ë¦¬ íƒ­
            if(sortedKeys.length === 0) {
                listBody.innerHTML = "<tr><td colspan='5' class='text-center p-3'>ë°ì´í„° ì—†ìŒ</td></tr>";
            } else {
                sortedKeys.forEach((key, index) => {
                    const s    = sessionsData[key];
                    const date = new Date(s.createdAt).toLocaleDateString();
                    const tr   = document.createElement('tr');
                    let actionHtml = '';
                    if(isEditMode) {
                        actionHtml = `
                            <button class="btn btn-sm btn-outline-secondary btn-move-up me-1" data-index="${index}" title="ìœ„ë¡œ"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn btn-sm btn-outline-secondary btn-move-down me-1" data-index="${index}" title="ì•„ë˜ë¡œ"><i class="fas fa-arrow-down"></i></button>
                            <button class="btn btn-sm btn-outline-danger btn-delete ms-2" data-key="${key}" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                        `;
                    } else {
                        actionHtml = `
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input toggle-visible" type="checkbox" data-key="${key}" ${s.isVisible ? 'checked' : ''}>
                                    <label class="form-check-label small text-nowrap" style="min-width:30px;">${s.isVisible ? 'ê³µê°œ' : 'ìˆ¨ê¹€'}</label>
                                </div>
                                <div class="vr"></div>
                                <button class="btn btn-sm btn-dark btn-monitor text-nowrap" data-key="${key}">ê²°ê³¼</button>
                            </div>
                        `;
                    }
                    tr.innerHTML = `
                        <td class="text-muted">${index + 1}</td>
                        <td><span class="badge bg-${s.type === 'startup' ? 'primary' : 'success'}">${s.type.toUpperCase()}</span></td>
                        <td class="fw-bold">${s.name}</td>
                        <td>${date}</td>
                        <td class="text-center">${actionHtml}</td>
                    `;
                    listBody.appendChild(tr);
                });

                if(!isEditMode) {
                    document.querySelectorAll('.toggle-visible').forEach(el =>
                        el.addEventListener('change', e =>
                            update(ref(db, `sessions/${e.target.dataset.key}`), { isVisible: e.target.checked })
                        )
                    );
                    document.querySelectorAll('.btn-monitor').forEach(el =>
                        el.addEventListener('click', e => enterMonitor(e.target.dataset.key))
                    );
                } else {
                    document.querySelectorAll('.btn-delete').forEach(el =>
                        el.addEventListener('click', e => deleteSession(e.currentTarget.dataset.key))
                    );
                    document.querySelectorAll('.btn-move-up').forEach(el =>
                        el.addEventListener('click', e => moveSession(e.currentTarget.dataset.index, -1))
                    );
                    document.querySelectorAll('.btn-move-down').forEach(el =>
                        el.addEventListener('click', e => moveSession(e.currentTarget.dataset.index, 1))
                    );
                }
            }

            // ê³¼ê±° ì‹¬ì‚¬ ì´ë ¥ íƒ­
            let proceedCount = 0, noproceedCount = 0;

            if(filteredKeys.length === 0) {
                historyBody.innerHTML = "<tr><td colspan='8' class='text-center p-3 text-muted'>ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            } else {
                filteredKeys.forEach((key, idx) => {
                    const s     = sessionsData[key];
                    const date  = new Date(s.createdAt).toLocaleDateString();
                    const count = s.evaluations ? Object.keys(s.evaluations).length : 0;
                    const avg   = calcSessionAvg(s);

                    if(s.investStatus === 'proceed')   proceedCount++;
                    if(s.investStatus === 'noproceed') noproceedCount++;

                    let investHtml = '<span class="text-muted small">-</span>';
                    if(s.investStatus === 'proceed')
                        investHtml = '<span class="invest-proceed">â— ì§„í–‰</span>';
                    else if(s.investStatus === 'noproceed')
                        investHtml = '<span class="invest-noproceed">â— ë¯¸ì§„í–‰</span>';

                    const trH = document.createElement('tr');
                    trH.innerHTML = `
                        <td class="text-muted">${idx + 1}</td>
                        <td><span class="badge bg-${s.type === 'startup' ? 'primary' : 'success'}">${s.type.toUpperCase()}</span></td>
                        <td class="fw-bold text-start">${s.name}</td>
                        <td>${date}</td>
                        <td>${count}ëª…</td>
                        <td class="fw-bold text-primary">${avg !== null ? avg : '-'}</td>
                        <td>${investHtml}</td>
                        <td>${s.isVisible
                            ? '<span class="text-primary fw-bold">ì§„í–‰ì¤‘</span>'
                            : '<span class="text-secondary">ì™„ë£Œ</span>'}</td>
                    `;
                    historyBody.appendChild(trH);
                });
            }

            historyFoot.innerHTML = `
                <tr>
                    <td></td>
                    <td colspan="1" class="text-center">Total : ${filteredKeys.length}ê±´</td>
                    <td colspan="4"></td>
                    <td class="text-center" style="font-size:0.82rem; line-height:1.5;">
                        <span class="invest-proceed">ì§„í–‰ : ${proceedCount}ê±´</span><br>
                        <span class="invest-noproceed">ë¯¸ì§„í–‰ : ${noproceedCount}ê±´</span>
                    </td>
                    <td></td>
                </tr>
            `;
        }

        function createSession() {
            const type = document.getElementById('new-type').value;
            const name = document.getElementById('new-name').value;
            if(!name) return alert("ì•ˆê±´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

            const btn = document.getElementById('btn-create-session');
            const originalText = btn.innerText;
            btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;

            let newOrder = 0;
            try {
                const keys = Object.keys(sessionsData || {});
                let minOrder = 0;
                if(keys.length > 0)
                    keys.forEach(k => {
                        const o = (sessionsData[k]?.order !== undefined) ? sessionsData[k].order : 0;
                        if(o < minOrder) minOrder = o;
                    });
                newOrder = minOrder - 1000;
            } catch(err) {
                newOrder = Date.now() * -1;
            }

            push(ref(db, 'sessions'), { name, type, isVisible: false, createdAt: Date.now(), order: newOrder })
            .then(() => { alert("ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('new-name').value = ""; })
            .catch(error => {
                console.error(error);
                if(error.code === "PERMISSION_DENIED" || error.message.includes("PERMISSION_DENIED"))
                    alert("âš ï¸ ì €ì¥ ì‹¤íŒ¨: ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nFirebase ê·œì¹™ì—ì„œ .writeë¥¼ trueë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
                else
                    alert("ì €ì¥ ì‹¤íŒ¨ ì˜¤ë¥˜: " + error.message);
            })
            .finally(() => { btn.innerText = originalText; btn.disabled = false; });
        }

        function deleteSession(key) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©° ëª¨ë“  í‰ê°€ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.")) {
                remove(ref(db, `sessions/${key}`))
                    .then(() => alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."))
                    .catch(err => alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message));
            }
        }

        function moveSession(indexStr, direction) {
            const index      = parseInt(indexStr);
            const sortedKeys = getSortedKeys();
            if(direction === -1 && index === 0)                   return;
            if(direction ===  1 && index === sortedKeys.length-1) return;

            const currentKey   = sortedKeys[index];
            const targetKey    = sortedKeys[index + direction];
            const currentOrder = sessionsData[currentKey].order || 0;
            const targetOrder  = sessionsData[targetKey].order  || 0;

            let newCurrentOrder = targetOrder;
            let newTargetOrder  = currentOrder;
            if(currentOrder === targetOrder) {
                newCurrentOrder = currentOrder + direction;
                newTargetOrder  = currentOrder - direction;
            }
            const updates = {};
            updates[`sessions/${currentKey}/order`] = newCurrentOrder;
            updates[`sessions/${targetKey}/order`]  = newTargetOrder;
            update(ref(db), updates);
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn      = document.getElementById('btn-toggle-edit-mode');
            const thStatus = document.getElementById('th-status-title');
            if(isEditMode) {
                btn.classList.replace('btn-outline-secondary','btn-danger');
                btn.innerHTML      = '<i class="fas fa-check"></i> í¸ì§‘ ì™„ë£Œ';
                thStatus.innerText = "ìˆœì„œ ë³€ê²½ / ì‚­ì œ";
            } else {
                btn.classList.replace('btn-danger','btn-outline-secondary');
                btn.innerHTML      = '<i class="fas fa-tools"></i> ëª©ë¡ í¸ì§‘ (ìˆœì„œ/ì‚­ì œ)';
                thStatus.innerText = "ê´€ë¦¬ ë° ê²°ê³¼";
            }
            renderAdminList();
        }

        function enterMonitor(key) {
            currentSessionId = key;
            if(selectedUsersForChart.length === 0) selectedUsersForChart = ['average'];
            document.getElementById('admin-monitoring').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            loadMonitorData(key);
        }

        function refreshMonitorView() { if(currentSessionId) loadMonitorData(currentSessionId); }

        function loadMonitorData(key) {
            const session = sessionsData[key];
            if(!session) return;
            document.getElementById('monitor-title').innerText = `ğŸ“Š ${session.name} ë¶„ì„ ê²°ê³¼`;
            renderInvestStatusLabel(session.investStatus || null);
            renderFeedback();
            calculateAndRenderChart(session);
        }

        function renderFeedback() {
            const session = sessionsData[currentSessionId];
            const isAnon  = document.getElementById('anon-toggle').checked;
            const evals   = session.evaluations || {};
            const prosDiv = document.getElementById('fb-pros-list');
            const consDiv = document.getElementById('fb-cons-list');
            const synDiv  = document.getElementById('fb-syn-list');
            prosDiv.innerHTML = ""; consDiv.innerHTML = ""; synDiv.innerHTML = "";

            const userNames = Object.keys(evals).sort();
            let hasData = false;
            userNames.forEach((user, idx) => {
                hasData = true;
                const e = evals[user];
                // â˜… ë³€ê²½: 'ì‹¬ì‚¬ìœ„ì›' â†’ 'ìµëª…'
                const displayName = isAnon ? `ìµëª…${idx + 1}` : user;
                const prefix = `<strong>${displayName}:</strong> `;
                if(e.pros)    prosDiv.innerHTML += `<div class="feedback-box">${prefix}${e.pros}</div>`;
                if(e.cons)    consDiv.innerHTML += `<div class="feedback-box cons">${prefix}${e.cons}</div>`;
                if(e.synergy) synDiv.innerHTML  += `<div class="feedback-box syn">${prefix}${e.synergy}</div>`;
            });
            if(!hasData) prosDiv.innerHTML = "<small class='text-muted'>ì•„ì§ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</small>";
        }

        function calculateAndRenderChart(session) {
            const evals     = session.evaluations || {};
            const labels    = criteria[session.type];
            const userNames = Object.keys(evals).sort();
            const isAnon    = document.getElementById('anon-toggle').checked;

            let count = 0, sums = new Array(6).fill(0),
                maxScores = new Array(6).fill(0), minScores = new Array(6).fill(5);
            const userScores = {};

            userNames.forEach(user => {
                count++;
                const scores = evals[user].scores;
                userScores[user] = scores;
                scores.forEach((s, i) => {
                    sums[i] += s;
                    if(s > maxScores[i]) maxScores[i] = s;
                    if(s < minScores[i]) minScores[i] = s;
                });
            });
            if(count === 0) minScores.fill(0);

            const averages = sums.map(s => count > 0 ? (s / count).toFixed(1) : 0);
            const totalAvg = count > 0
                ? (averages.reduce((a,b) => parseFloat(a)+parseFloat(b), 0) / 6).toFixed(1)
                : "0.0";

            document.getElementById('total-score-display').innerText = totalAvg;
            const scoreList = document.getElementById('score-breakdown-list');
            scoreList.innerHTML = "";
            labels.forEach((label, idx) => {
                scoreList.innerHTML += `
                    <div class="score-list-item">
                        <span>${label}</span>
                        <div class="text-end">
                            <span class="fw-bold fs-6">${averages[idx]}</span>
                            <span class="score-detail">(ìµœê³  ${maxScores[idx]} / ìµœì € ${minScores[idx]})</span>
                        </div>
                    </div>`;
            });

            const controlsDiv = document.getElementById('chart-users-toggle');
            let controlsHTML = `<span class="fw-bold me-3">í‘œì‹œ:</span>
                <label><input type="checkbox" class="chart-checkbox" value="average" ${selectedUsersForChart.includes('average')?'checked':''}> <span class="badge bg-primary">í‰ê· </span></label>`;
            userNames.forEach((user, idx) => {
                // â˜… ë³€ê²½: 'ì‹¬ì‚¬ìœ„ì›' â†’ 'ìµëª…'
                const displayName = isAnon ? `ìµëª…${idx + 1}` : user;
                const isChecked   = selectedUsersForChart.includes(user) ? 'checked' : '';
                controlsHTML += `<label><input type="checkbox" class="chart-checkbox" value="${user}" ${isChecked}> ${displayName}</label>`;
            });
            controlsDiv.innerHTML = controlsHTML;

            document.querySelectorAll('.chart-checkbox').forEach(el => {
                el.addEventListener('change', e => {
                    const val = e.target.value;
                    if(e.target.checked) selectedUsersForChart.push(val);
                    else selectedUsersForChart = selectedUsersForChart.filter(item => item !== val);
                    if(currentSessionId) calculateAndRenderChart(sessionsData[currentSessionId]);
                });
            });

            const datasets = [];
            if(selectedUsersForChart.includes('average'))
                datasets.push({ label: 'í‰ê· ', data: averages, backgroundColor: 'rgba(13,110,253,0.2)', borderColor: '#0d6efd', borderWidth: 3, pointBackgroundColor: '#0d6efd' });

            userNames.forEach((user, idx) => {
                if(selectedUsersForChart.includes(user)) {
                    // â˜… ë³€ê²½: 'ì‹¬ì‚¬ìœ„ì›' â†’ 'ìµëª…'
                    const displayName = isAnon ? `ìµëª…${idx + 1}` : user;
                    const color = `hsl(${(idx * 137) % 360}, 70%, 50%)`;
                    datasets.push({ label: displayName, data: userScores[user], borderColor: color, borderWidth: 2, fill: false, pointBackgroundColor: color });
                }
            });

            if(myRadarChart) myRadarChart.destroy();
            const ctx = document.getElementById('adminChart').getContext('2d');
            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: { labels, datasets },
                options: {
                    scales: { r: { min: 0, max: 5, ticks: { stepSize: 1 } } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderIcList() {
            const listDiv    = document.getElementById('ic-session-list');
            listDiv.innerHTML = "";
            const sortedKeys = getSortedKeys();
            let hasItem = false;

            sortedKeys.forEach(key => {
                const s = sessionsData[key];
                if(s.isVisible) {
                    hasItem = true;
                    const isDone = s.evaluations && s.evaluations[currentUserName];
                    const btn    = document.createElement('button');
                    btn.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 border shadow-sm btn-ic-eval";
                    btn.setAttribute('data-key', key);
                    btn.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${s.type==='startup'?'primary':'success'} me-3 p-2">${s.type.toUpperCase()}</span>
                            <span class="fw-bold fs-5">${s.name}</span>
                        </div>
                        ${isDone
                            ? '<span class="text-success fw-bold"><i class="fas fa-check-circle"></i> í‰ê°€ ì™„ë£Œ</span>'
                            : '<span class="badge bg-secondary">í‰ê°€ í•˜ê¸°</span>'}
                    `;
                    listDiv.appendChild(btn);
                }
            });
            if(!hasItem)
                listDiv.innerHTML = "<div class='text-center p-5 text-muted'>ì§„í–‰ ì¤‘ì¸ ì‹¬ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";

            document.querySelectorAll('.btn-ic-eval').forEach(el =>
                el.addEventListener('click', e => openEvaluation(e.currentTarget.dataset.key))
            );
        }

        function openEvaluation(key) {
            currentSessionId = key;
            const session    = sessionsData[key];
            document.getElementById('ic-dashboard').classList.add('hidden');
            document.getElementById('ic-evaluation').classList.remove('hidden');
            document.getElementById('eval-title').innerText = session.name;
            const container = document.getElementById('criteria-inputs');
            container.innerHTML = "";
            criteria[session.type].forEach((item, idx) => {
                container.innerHTML += `
                    <div class="mb-4">
                        <label class="d-flex justify-content-between">
                            <span class="fw-bold">${item}</span>
                            <span id="score-val-${idx}" class="badge bg-primary fs-6">3.0</span>
                        </label>
                        <input type="range" class="form-range" min="0" max="5" step="0.5" id="criteria-${idx}" value="3"
                            oninput="document.getElementById('score-val-${idx}').innerText=this.value">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                        </div>
                    </div>`;
            });
            document.getElementById('comment-pros').value    = "";
            document.getElementById('comment-cons').value    = "";
            document.getElementById('comment-synergy').value = "";
        }

        function submitEvaluation() {
            const session = sessionsData[currentSessionId];
            const scores  = [];
            criteria[session.type].forEach((_, idx) =>
                scores.push(parseFloat(document.getElementById(`criteria-${idx}`).value))
            );
            const feedback = {
                user:      currentUserName,
                scores,
                pros:      document.getElementById('comment-pros').value,
                cons:      document.getElementById('comment-cons').value,
                synergy:   document.getElementById('comment-synergy').value,
                timestamp: Date.now()
            };
            set(ref(db, `sessions/${currentSessionId}/evaluations/${currentUserName}`), feedback)
                .then(() => { alert("ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤."); goHome(); });
        }

    } catch(e) {
        document.getElementById('loading-overlay').classList.remove('hidden');
        document.getElementById('global-error-msg').innerText = "ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message;
    }
</script>
</body>
</html>
